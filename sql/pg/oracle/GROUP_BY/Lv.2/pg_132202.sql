-- 문제 링크 (주석) : https://school.programmers.co.kr/learn/courses/30/lessons/132202
-- 간단한 문제 설명 : 
--   - APPOINTMENT 테이블에서 2022년 5월에 예약한 환자 수를 진료과코드별로 조회
--   - 이름이 없는 동물은 제외
--   - 결과는 진료과 코드와 5월 예약 건수로 구성되며, 예약 건수를 기준으로 오름차순 정렬하고 동일 시 진료과 코드를 기준으로 오름차순 정렬

-- -----------------------------------------------------------------------------------------
-- 테이블 스키마 :
--   - 테이블명 : APPOINTMENT
--     - APNT_YMD			TIMESTAMP	FALSE	-- 진료예약일시
--     - APNT_NO			NUMBER(5)	FALSE	-- 진료예약번호
--     - PT_NO			VARCHAR(10)	FALSE	-- 환자번호
--     - MCDP_CD			VARCHAR(6)	FALSE	-- 진료과코드
--     - MDDR_ID			VARCHAR(10)	FALSE	-- 의사ID
--     - APNT_CNCL_YN	VARCHAR(1)	TRUE	-- 예약취소여부
--     - APNT_CNCL_YMD	DATE		TRUE	-- 예약취소날짜
-- -----------------------------------------------------------------------------------------
-- 해결 방법 설명 :
--   1. APPOINTMENT 테이블에서 2022년 5월에 예약한 환자만 선택하기 위해 WHERE 절에 TO_CHAR(APNT_YMD, 'YYYY-MM') = '2022-05' 조건 추가
--   2. 예약이 취소되지 않은 경우만 선택하기 위해 APNT_CNCL_YN = 'N' 조건 추가
--   3. 진료과코드별로 그룹화를 수행하여 각 진료과의 예약 건수를 COUNT 함수로 계산
--   4. 결과를 예약 건수를 기준으로 오름차순 정렬하고, 예약 건수가 동일할 경우 진료과 코드를 기준으로 오름차순 정렬
--
-- 사용한 SQL 문법 및 함수 설명 :
--   - SELECT: 조회할 컬럼을 선택
--   - COUNT(*): 그룹별로 행의 개수를 계산
--   - FROM: 데이터를 조회할 테이블을 지정
--   - WHERE: 특정 조건을 만족하는 행만 선택
--   - TO_CHAR(timestamp, format): 타임스탬프를 지정한 형식의 문자열로 변환
--   - GROUP BY: 특정 컬럼을 기준으로 그룹화
--   - ORDER BY: 결과를 특정 컬럼 기준으로 정렬
--   - ASC: 오름차순 정렬 지정
--
-- 쿼리 최적화 방법 :
--   - APNT_YMD 컬럼에 인덱스를 생성하여 WHERE 절의 성능 향상
--     예시 인덱스 생성:
--       CREATE INDEX idx_appointment_apnt_ymd ON APPOINTMENT(APNT_YMD);
--   - MCDP_CD 컬럼에 인덱스를 생성하여 GROUP BY 및 ORDER BY 절의 성능 향상
--       CREATE INDEX idx_appointment_mcdp_cd ON APPOINTMENT(MCDP_CD);
--   - 필요한 컬럼만 SELECT 절에 포함하여 불필요한 데이터 스캔을 줄임
--
-- 시간/공간 복잡도 :
--   - 시간복잡도 : O(N)
--     -- 테이블 전체를 스캔하며 조건에 맞는 행을 필터링하고 그룹화를 수행하므로 선형 시간 복잡도
--   - 공간복잡도 : O(K)
--     -- 그룹화된 결과를 저장하기 위한 공간 (K는 고유 진료과코드의 수)
-- -----------------------------------------------------------------------------------------
-- 최종 쿼리
-- -------------------------------------------------------------------------------------------

SELECT 
    MCDP_CD AS "진료과코드", 
    COUNT(*) AS "5월예약건수"  -- 진료과별 5월 예약 건수 계산
FROM 
    APPOINTMENT
WHERE 
    TO_CHAR(APNT_YMD, 'YYYY-MM') = '2022-05'  -- 예약일이 2022년 5월인 경우
    AND APNT_CNCL_YN = 'N'                    -- 예약 취소되지 않은 경우
GROUP BY 
    MCDP_CD  -- 진료과 코드별로 그룹화
ORDER BY 
    "5월예약건수" ASC,  -- 5월 예약 건수를 기준으로 오름차순 정렬
    "진료과코드" ASC;  -- 예약 건수가 동일한 경우 진료과 코드를 기준으로 오름차순 정렬